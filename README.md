# YouTube Downloader Bot (@mrYTDownloaderBot)

Telegram-бот для скачивания видео и аудио с YouTube. Отправляешь ссылку — бот предлагает выбрать формат и качество, скачивает файл и отправляет его прямо в чат. Если файл крупнее 50 МБ — предлагает сжать или сохранить на Яндекс.Диск.

**Автор:** Andreas Maier

---

## Возможности

- Скачивание видео с YouTube по ссылке (форматы: `youtube.com/watch?v=...`, `youtu.be/...`, `youtube.com/shorts/...`)
- Выбор формата: **видео (MP4)** или **аудио (MP3)**
- Выбор разрешения для видео: 360p, 480p, 720p, 1080p (показываются только доступные)
- Выбор битрейта для аудио: **96 / 128 / 192 / 320 kbps**
- Отправка файла прямо в Telegram-чат (до 50 МБ)
- Для файлов крупнее 50 МБ — выбор действия через inline-кнопки:
  - **Сжать и отправить** — пересчитывает битрейт через ffmpeg и отправляет в Telegram
  - **Сохранить в Яндекс.Диск** — копирует файл в локальную папку Яндекс.Диска
- Видео и аудио сохраняются в разные подпапки Яндекс.Диска (`Video/` и `Audio/`)
- Whitelist — доступ только для разрешённых Telegram-пользователей

---

## Требования

- **Python 3.11+**
- **ffmpeg** — обязателен для слияния видео- и аудиопотоков (MP4), конвертации в MP3 и сжатия файлов
- **ffprobe** — обязателен для определения длительности файла при сжатии (входит в большинство ffmpeg-дистрибутивов)
- Оба бинарника должны быть доступны в `PATH` или указаны через `FFMPEG_PATH` в `.env`
- Telegram Bot Token (получить у [@BotFather](https://t.me/BotFather))
- Telegram User ID разрешённых пользователей (узнать через [@userinfobot](https://t.me/userinfobot))
- Яндекс.Диск, смонтированный локально (для файлов крупнее 50 МБ)

Проверить наличие ffmpeg и ffprobe:
```bash
ffmpeg -version
ffprobe -version
```

---

## Установка

```bash
# 1. Клонировать репозиторий
git clone https://github.com/Dronnn/youtubeDownloaderBot.git
cd youtubeDownloaderBot

# 2. Создать и активировать виртуальное окружение
python3 -m venv venv
source venv/bin/activate

# 3. Установить зависимости
pip install -r requirements.txt

# 4. Настроить переменные окружения
cp .env.example .env
# Открыть .env и заполнить все значения (см. таблицу ниже)
```

---

## Конфигурация (.env)

| Переменная | Описание |
|---|---|
| `BOT_TOKEN` | Токен Telegram-бота — получить у [@BotFather](https://t.me/BotFather) |
| `ALLOWED_USERS` | Telegram ID разрешённых пользователей через запятую |
| `YANDEX_DISK_PATH` | Путь к локальной папке Яндекс.Диска для больших файлов |
| `DOWNLOAD_DIR` | Директория для временных файлов (по умолчанию `/tmp/yt_downloads`) |
| `MAX_TELEGRAM_SIZE` | Максимальный размер файла для отправки через Telegram в байтах (по умолчанию `52428800` = 50 МБ) |
| `FFMPEG_PATH` | Абсолютный путь к бинарнику ffmpeg (по умолчанию `/usr/local/bin/ffmpeg`) |

> **Важно:** `FFMPEG_PATH` необходимо указывать явно при запуске через `nohup` или launchd, так как в этих режимах `$PATH` может не содержать `/usr/local/bin`.

---

## Запуск

```bash
source venv/bin/activate
python -m bot.main
```

---

## Деплой

Бот запускается на отдельном Mac в виртуальном окружении (`venv`). Зависимости Python изолированы в `venv`; ffmpeg и ffprobe устанавливаются в `/usr/local/bin` (статические бинарники или через Homebrew).

Рекомендуемый способ держать бота запущенным в фоне — `nohup` или системный LaunchAgent:

```bash
nohup python -m bot.main &> logs/bot.log &
```

---

## Использование

1. Отправить боту ссылку на YouTube-видео
2. Выбрать формат: **Видео** или **Аудио**
3. Для видео — выбрать разрешение из доступных (360p / 480p / 720p / 1080p)
4. Для аудио — выбрать битрейт (96 / 128 / 192 / 320 kbps)
5. Бот скачает файл и отправит его в чат
6. Если файл крупнее 50 МБ — бот предложит на выбор:
   - **Сжать и отправить** — файл будет пережат и отправлен в Telegram
   - **Сохранить в Яндекс.Диск** — файл скопируется в `Video/` или `Audio/` внутри указанной папки Яндекс.Диска, бот пришлёт путь к нему

### Команды

| Команда | Описание |
|---|---|
| `/start` | Приветствие и краткая инструкция |
| `/help` | Описание работы бота |

---

## Структура проекта

```
youtubeDownloaderBot/
├── bot/
│   ├── __init__.py
│   ├── main.py          # Точка входа, инициализация и запуск бота
│   ├── config.py        # Загрузка конфигурации из .env
│   ├── handlers.py      # Обработчики команд и inline callback-кнопок
│   └── downloader.py    # Скачивание через yt-dlp (видео и аудио), сжатие
├── docs/                # Документация и планы
├── logs/                # Логи разработки
├── .env.example         # Пример файла конфигурации
├── requirements.txt     # Python-зависимости
└── README.md
```
